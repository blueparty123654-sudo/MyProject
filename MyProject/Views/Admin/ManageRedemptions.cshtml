@model List<MyProject.ViewModels.AdminRedemptionViewModel>
@{
    ViewData["Title"] = @Localizer["Manage Redemptions"];
    var currentFilter = ViewBag.FilterStatus as string ?? "All";
    var availableStatuses = ViewBag.AvailableStatuses as List<string> ?? new List<string>();
}

<div class="container mt-4">
    <h2 class="text-center mb-4"><i class="fas fa-gift me-2 text-warning"></i>@Localizer["Manage Redemptions"]</h2>

    @* --- แสดง TempData Messages --- *@
    @if (TempData["AdminSuccess"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["AdminSuccess"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["AdminError"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["AdminError"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @* --- Filter Form --- *@
    <form asp-action="ManageRedemptions" method="get" class="row g-3 mb-4 align-items-end">
        <div class="col-md-4">
            <label for="filterStatus" class="form-label">@Localizer["Filter by status:"]</label>
            <select name="filterStatus" id="filterStatus" class="form-select">
                <option value="All" selected="@(currentFilter == "All")">@Localizer["-- All --"]</option>
                @foreach (var statusOption in availableStatuses) @* <<< (แก้ไข) ใช้ตัวแปรนี้ *@
                {
                    <option value="@statusOption" selected="@(currentFilter == statusOption)">@Localizer[statusOption]</option> @* <<< แปล Status *@
                }
            </select>
        </div>
        <div class="col-md-auto">
            <button type="submit" class="btn btn-warning">@Localizer["Filter"]</button> @* ใช้สีเหลือง *@
        </div>
        <div class="col-md-auto ms-auto">
            @* ปุ่มกลับ Dashboard *@
            <a asp-action="Index" asp-controller="Admin" class="btn btn-secondary"><i class="fas fa-arrow-left me-1"></i> @Localizer["Back to Dashboard"]</a>
        </div>
    </form>

    @if (Model.Any())
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>@Localizer["Redemption ID"]</th>
                        <th>@Localizer["Customer"]</th>
                        <th>@Localizer["Giveaway"]</th>
                        <th>@Localizer["Redemption Date"]</th>
                        <th>@Localizer["Current Status"]</th>
                        <th>@Localizer["Change Status"]</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>@item.RedemptionId</td>
                            <td>@item.UserName (@Localizer["ID"]: @item.UserId)</td>
                            <td>@item.GiveawayName (@Localizer["ID"]: @item.GiveawayId)</td>
                            <td>@item.RedemptionDate.ToString("g", new System.Globalization.CultureInfo("th-TH"))</td>
                            <td><span class="badge @GetRedemptionStatusBadgeClass(item.CurrentStatus)">@Localizer[item.CurrentStatus]</span></td> @* <<< แปล Status *@
                            <td>
                                <form asp-action="UpdateRedemptionStatus" method="post" class="d-inline-flex align-items-center status-update-form">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="redemptionId" value="@item.RedemptionId" />
                                    <select name="newStatus" class="form-select form-select-sm me-2" required>
                                        @foreach (var status in availableStatuses) @* <<< (แก้ไข) ใช้ตัวแปรนี้ *@
                                        {
                                            <option value="@status" selected="@(status == item.CurrentStatus)">@Localizer[status]</option> @* <<< แปล Status *@
                                        }
                                    </select>
                                    <button type="submit" class="btn btn-sm btn-success">
                                        <i class="fas fa-save"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <p class="text-center text-muted mt-4">@Localizer["No redemption records found matching the selected criteria."]</p>
    }
</div>

@* Helper function (ไม่ต้องแปล) *@
@functions {
    string GetRedemptionStatusBadgeClass(string status)
    {
        return status switch
        {
            "Completed" => "bg-success",
            "Processing" => "bg-info text-dark",
            "Shipped" => "bg-primary",
            "Cancelled" => "bg-danger",
            _ => "bg-secondary",
        };
    }
}